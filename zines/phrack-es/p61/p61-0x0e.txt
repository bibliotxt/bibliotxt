   ==Phrack Inc.==

               Volume 0x0b, Issue 0x3c, Phile #0x0e of 0x10

|=---------------------------=[ Semáforos ]=-----------------------------=|
|=-----------------------------------------------------------------------=|
|=-----------------------=[ plunkett@hush.com ]=-------------------------=|

.:Salvando el planeta, de nuevo:.

/*
* Esto es puramente educacional;
* Cualquier conocimiento obtenido desde este documento es autoimpuesto y
* por eso el autor no puede hacerse responsable. Cualquier actividad
* resultante del conocimiento adquirido en este documento no es
* justificable por el autor. Si no aceptas estas condiciones, por favor
* abstente de leer este documento.
*
*/
#include <disclaimer.h>

Una forma ambientalmente más amigable de viajar por auto. Como alguno de
ustedes puede recordar que prácticamente en todas las películas, libros,
programas de TV, entre otros, sobre hacking, ha habido alguien manoseando
los semáforos. Bueno, todos nos reímos del aspecto irreal de la situación y
no le dimos vuelta al asunto. Bueno, en mi cruzada por un planeta más
atractivo para nuestros niños me sentí compelido a pensar en una forma de
reducir la cantidad de contaminación emitida por los vehículos de hoy en
día.
Detenido en una intersección, nadie a la vista, estás aun atascado detrás de
la luz roja, y la barrera invisible de culpa gubernamental tiene el
suficiente poder para dejarte esperando ahí y contaminar el aire más y más,
todo por una ínfima luz verde. No sería 'leet' tener un laptop en tu auto
donde pudieras seleccionar la intersección desde una lista,  cambiar el
cronometraje o la secuencia de marcha y pasear con menos tiempo
desperdiciado y menos contaminación evacuada y una conciencia limpia.

Ya, suficiente majadería sobre los por que, ahora vamos por lo técnico.

El sistema de control de tráfico de hoy es una red redundante bien engrasada
que utiliza los mismos protocolos que todos nosotros conocemos. Sí, es
hackeable y es como en las películas. :)
aquí vamos!

una descripción de algunos de los términos usados.

- controlador
	Este es el término técnico para un semáforo y será llamado de esa
	forma
- UTC
	Controlador de Tráfico Urbano, controladores de señal sólida
	conectados al computador central por medio de PSTN. Provee los
	estándares de comunicación para los controladores (ver fig. 1)

- SCOOT
	Técnica de Optimización de División de Offset de Cíclo
	Un estándar implementado a través de la mayoría de los sistemas de
	tráfico alrededor del mundo. Provee control adaptable de los
	controladores, esto es hecho por la oficina de control, recibe el
	flujo de tráfico de un círculo cerrado en torno de las
	intersecciones, que es analizada y envía configuraciones
	actualizadas en tiempo real de vuelta a los controladores.

- ITS
	Sistemas de Transporte Inteligente. Este es solo cliché para
	describir el sistema completo abarcando todo, UTC, SCOOT,
	CTV(video) y el protocolo completo que interconecta todo.
	(ver fig. 2)

- NTCIP
	Este es el protocolo que está en proceso de convertirse en el
	estándar de administración de comunicaciones de tráfico. Está basado
	en TCP/IP y circula mayoritariamente en SNMP que tiene un MIB
	específico para usar en mensajería de control. (el protocolo puede
	variar de país en país) Algunos controladores en US son compatibles
	con NTCIP, por nombrar algunos, Thereon y el modelo 170 de los
	controladores NEMA. CCTV, VMS,  Field Processors, Ramp metering
	están todos conectados vía NTCIP.

- ATC
	Control de Tráfico de Area, esta es la oficina central que controla
	todos los aspectos de la administración de control de tráfico.

- FEP
	Procesador Frontal, Procesamiento Virtual para controladores.
	Localizado antes del computar de administración, y conectado
	directamente a los controladores por medio de un modem rack
	instation o hardware de telemetría. Un FEP soporta hasta 512 líneas
	PSTN.

- OTU
	En UK es la Unidad de Transmisión de Estación lejana, esto provee el
	método para convertir datos serial entrantes del computador central
	a datos paralelos usados en el controlador, y provee
	intercambiabilidad de controladores.
	(No estoy seguro si este sistema es un estándar a través del mundo,
	en Africa del Sur esto es hecho por un CCIU - Unidad de Interfase de
	Comunicación de Controlador)

- CMU
	Unidad de Monitoreo de Gabinete, Esto es lo que detecta cuando tu
	hurgueteas dentro del caja cercana a la calle. Reporta fallas de
	hardware/software y empaqueta los datos para reportarlos al FEP y
	ATC.



Figura 1. Diferentes configuraciones de enlace
----------------------------------------------

                      ---0 empalme 1
                     /
   0-----------------0----0 empalme 2
OFICINA  INTRCAMBIO \
CENTRAL    LOCAL     ---0 empalme 3

              [Configuración UTC Radial]


                  ---0  empalme 1
                 /    \
   0------------0      \
  O.C          I.L   0-- empalme 2
                       /
                      /
                     0 empalme 3

           [Configuración UTC de Múltiple-bajada UK]


Figura 2. Topologías ITS
------------------------

         __________     __________        __________
        |COMPUTADOR|---|COMPUTADOR|------|COMPUTADOR|
        `----------'   `----------'      `----------'
  (coax)    |_____         |  (dialup)        |__    (radio)
                   |       |                  |
      ___________  |   ____|______       _____|______
     |CONTROLADOR|-|  |  MAESTRO  |__   |PROC. CAMPO |__
     `-----------' |  `-----------'  |  `------------'  |
      ___________  |   ___________   |   ____________   |
     | VAX/VMS   |-|  |  VAX/VMS  |__|  |CAMARA CCTV |__|
     `-----------' |  `-----------'  |  `------------'  |
      ___________  |   ___________   |   ____________   |
     |COUNTSTION |-|  |CONTROLADOR|__|  |CONTROLADOR |__|
     `-----------'    `-----------'     `------------'  |
                                         ___________    |
                                        | VAX/VMS   |___|
                                        `-----------'

    (Enlaces físicos   (Enlace físicos   (Enlaces físicos
     EIA 232)           FSK-modem)        Fibra)




Introducción
------------

Las cajas controladoras de tráfico que tu ves en el camino tienen todas una
configuración estándar puesta cuando son enviadas, pero todas están
enlazadas a una oficina central por cambios en la configuración de forma
remota, reportes de falla, reseteo, etc.
El ATC alberga un FEP que se conecta a cada controlador o al intercambio
local. El FEP es la conexión directa de red a los controladores y busca en
los controladores segundas bases y recibe las respuestas que son
transportadas al computador de control central (OS/2 o ALPHA VAX en SA y UK)
vía DECnet en coaxial u otros medios por la LAN. Luego, el computador de
control analiza el resultado y determina fallas u otros datos y los coloca
en la base de datos del controlador central en un VAX/VMS. La base de datos
es posteriormente priorizada y puede ser accedida vía interfase web en la
intranet local para ver reportes de fallas e info de cronometraje.

Cuando una reconfiguración es decretada, un operador puede fijar todas las
configuraciones de forma remota incluso si es requerido un reseteo total de
los controladores. Esto incluye los cronometrajes de flujos (flujos son las
diversas configuraciones de cronometraje), tiempo local, apagado de luces,
flujo de emergencia (para ambulancia y similares), las diferentes
configuraciones serán discutidas más adelante. Cuando el operado pide un
cambio en la configuración, es enviado al FEP en un datagrama largo que es
dividido y modulado para la comunicación al controlador. Los protocolos
entre la OTU/CCIU y el FEP no son estándar usualmente, y protocolos de
propiedad son fijados por el manufacturador de la unidad.

aquí se muestra un diagrama de como el UTC es intercalado. (fig. 3)

figura 3. Protocolo y diagrama de enlace físico de un sistema UTC
-----------------------------------------------------------------

                            ATC                  EN CAJA CONTROLADORA
   _______________                        :
  |COMPUTADOR UTC |        RS232 SERIAL   :
  `---------------'                       :         SERIAL
         |                    ___ ______  :   _____   :   ________
         | DECnet-> _______  |___|MODEM |-/--|MODEM|-----|OTU/CCIU|
TCP/IP   |---------|  FEP  |_|___| RACK | :  `-----'     `--------'
ETHERNET |         `-------' |___`------' :                  | RS232
LAN   -> |                                :                  | SERIAL
         | (protocolos NTCIP)             :               ___|_______
         |   circundantes                 :              |CONTROLADOR|
         |    _______                     :              `-----------'
         |___|       |                    :
             `-------'                    :
             disp. varios                 :
             como VAX/VMS para            :
	     monitoreo de fallas
	     y similares


La comunicación entre el controlador y el ATC es realizada mediante un flujo
de señales de bit donde ciertos bits representan una función preprogramada
en un controlador.
Un flujo serial de bit segundo-a-segundo es recibido por cada controlador de
forma continua y es convertido a paralelo para su uso dentro del
controlador. El flujo consiste de 16 bits, de manera que 32 conexiones
paralelas pueden ser iniciadas con el controlado, ciertos controles de
flujos de bit y ciertas funciones; y algunas tienen un valor de retorno por
ejemplo para notificar un controlador el cual su flujo esté actualmente
corriendo. La comunicación puede ver similar a esto.

1001011011011101 sent
1000101111010101 received

como se dijo, el protocolo de comunicación es más propenso a ser
conveniente que estándar. por ejemplo. El bit 10 de control puede que
signifique "fijar el tiempo máximo de verde a 30s" y en otro "mantener la
plataforma del vehículo". Pero de acuerdo a los estándares globales ATC, hay
un par de estándares como control de flujo, control de emergencia, reseteo y
otras características ingeniosas.

Pero esto no es importante porque acceder al computador controlador es de
cualquier forma necesario para controlar los controladores, y por eso el
protocolo específico usado no importa.


-----------------------------------------
detalles técnicos de comunicación, yami!
-----------------------------------------

Mensajería UTC
--------------

A continuación hay una típica descripción de la comunicación entre el
controlador y el ATC. UTC es el sistema actual que es usado en la mayoría de
los centros ATC alrededor del mundo. Y la comunicación es bastante estándar.
Los bits de datos específicos de la mensajería pueden ser diferente en
distintos países ya que esto es hecho según la conveniencia de los
manufacturadores del controlador y del sistema. Pero tienden a apegarse al
estándar, el sistema de  Africa del Sur está basado en el de UK, y el
sistema de UK es el mismo de America, y por lo tanto todos se verán
básicamente igual, excepto por funciones específicas de cada área.

Control UTC y Bits de Respuesta  (Fn = F1,F2,F3... diferentes etapas, lo
-------------------------------        mismo para Dx)
Control	    Descripción					Respuesta

Dn (o Dx)   Demanda etapa individual			SDn/SDx
Fn	    Fuerza una etapa
FM	    Modo de retroceso				FC
HI	    Freno de llamada apurada
	    Confirmación de etapa, Etapa n		Gn
	    Confirma. de llamada apurada o petición	HC
	    Control manual				MC
	    Vehículo de emergencia			EV
	    Falla de luz roja de vehículo 1		RF1
	    Falla de luz roja de vehículo 2		RF2
SFn	    Habitación de swith				SCn
SO	    Anulación solar
SG	    Sincronización de cronometro del grupo CFL	CG
LO	    Luces Apagadas/Encendidas			LE
LL	    Frendo de enlace local
TS	    Valor almacenado de tiempo de sincr. switch
TO	    Apoderarse
CP	    Cerrar estacionamiento de autos		CL
	    Monitor detector de falla			DF
	    Cronómetro de grupo CFL en el 1º grupo	GR1
	    Reconexión remota				RR
	    Entrada en Log de controlador de falla	CF
	    Microteléfono conectado			TF
	    Falla de lámpara				LFn
	    Estacionamiento de autos excedido		CA
	    Confirmación de Verde de peatones		PC
	    Presencia de detector de fila		VQ
	    Detector de conteo de vehículos		VC
	    Información de estacionamiento de auto	CSn
	    Fila en la entrada de la reserva de estc.	CR
	    Presencia de detector SCOOT			Vsn
	    Puerta de gabinete abierta			CO
PV	    Mantener etapa de vehículo
PX	    Demanda de etapa de peatones
	    Período de limpieza				PR
	    Confirmación de Verde para vehículo		GX
	    Confirmación de indicador de espera		WI

Un controlador está típicamente configurado para recibir 16 o 32 bits de
bits de controles que pueden ser reenviados por el controlador usando un
datagrama de respuesta.
(Nótese que las funciones específicas SCOOT son hechas de la misma forma)

mensaje típico de Control UTC:

Bytes 1,2 Control Bytes (Address 2)
Byte 3 (F1,F2,F3,D2,D3,DX,SO,-)    (chequear tabla para descripción de bit)
Byte 4 (-,-,-,-,-,-,-,TS)

0 0 0 0 0 0 1 0 0 1 0 1 0 0 1 0 0 0 0 0 0 0 0 0

mensaje típico de respuesta UTC:

Bytes 1,2 Reply Bytes (Address 2)
Byte 3 (G1,G2,G3,-,-,DF,CF,-)      (check above table for bit descr)
Byte 4 (-,-,-,-,-,-,-,RT)

0 0 0 0 0 0 1 0 0 1 0 1 0 0 1 0 0 0 0 0 0 0 0 0

La comunicación es hecha de forma asincrónica y en el controlador es
representada como paralela, mientras que en el FEP es serial. La modulación
se puede hacer por FETP o tarjetas controladoras específicas dentro de la
estación.


Mensajería NTCIP (UK y algunos ATC de US)
-----------------------------------------

No voy a discutir el sistema de mensajería NTCIP específico porque aún no es
fijado como un estándar todavía, y básicamente, porque no he tenido el
placer de jugar con él. América (excepto NY y otras grandes ciudades),
Africa del Sur, Namibiba y pienso que la mayoría de las grandes ciudades
alrededor del mundo aun usan UTC con SCOOT puesto que UK está adoptándolo
como un estándar.

El stack NTCIP:

Capa		    Clase A	    Clase B	    Clase C
-----------------------------------------------------------------
Aplicación (7)	    SNMP/STMP       SNMP/STMP       SNMP/STMP/FTP
Presentación (6)    -               -               -
Sesión (5)	    -               -               -
Transporte (4)	    UDP             -               TCP/UDP
Red (3)		    IP              Null            IP
Enlace Datos (2)    HDLC            HDLC            HDLC
Físico (1)	    RS232/FSK       RS232/FSK       RS232/FSK

A y C no son estándares pero pueden ser usados. Para compatibilidad tcp y
routing. A y C pueden ser implementados además como stacks adicionales
TCP/IP.

B es definido como estándar y es usado por su eficiencia de bando de ancha
de datos pero no provee seguridad de entrega, esto es hecho a su vez por la
capa física que se encarga de las retransmisiones necesarias.

B solo contiene tres capas, aplicación, enlace de datos, y capa física. Esto
es porque la línea constante entre la oficina y el controlador es arreglada
y por eso no es necesario el routing y las características de la sesión
incluyen SNMP.

NTCP y SNMP y algo de STMP:

comandos SNMP:
-get
-set
-get Next/get Bulk
-trap

El administrador (ATC) puede enviar un comando 'get' para pedir información
del agente (CONTROLADOR) y espera por una respuesta. Pero SNMP no provee
para el agente el contacto de inicio, y por eso el administrador sondea
periódicamente con el comando 'trap'. Esto es hecho en una frecuencia por
segundo.

El típico marco SNMP es de 37 bytes
----------------------------------------------------------------------------
|ver|community|command|req id|error status|error index|objct id|objct value|
----------------------------------------------------------------------------

ver=
	SNMP v1 -NTCIP v2 incluidas características de seguridad que ellos
	pensaron que eran un desperdicio de ancho de banda ;)

Id flag=
	es usado para hacer coincidir los mensajes con sus respuestas

community name=
	esencialmente un password

core message in Object ID and Value=
	la sección de respuestas y datos del control del controlador

SNMP es un protocolo devorador de ancho de banda, por eso diseñaron STMP
(protocolo simple de administración de transporte) que es una versión
reducida de SNMP. Usa los mismos comandos pero tiene el beneficio añadido de
no tener header y usar objetos dinámicos. Los objetos dinámicos pueden
contener un número de variables como tiempo, fecha, año y todo en un objeto.
Los objetos son definidos en línea y ambas partes, la interna y externa de
la estación, saben lo que los objetos describen y por eso solo un valor
simple se necesita transmitir. El tamaño típico de un mensaje STMP es de 1
byte, con un máximo de 13 objetos dinámicos.


Comparación entre mensajería UTC y NTCIP
----------------------------------------
			    UK UTC	    NTCIP Clase B
Ciclo de sondeo		    1s		    1s
Tamaño de mensaje	    Fijo	    Variable
Variables de dispositivo
transmitido		    Todos	    Solo parámetros a ser cambiados
Valor de la variable
de dispositivo		    Bit		    Entero o Bit
Protocolos		    Propietario	    Estandarizado



------------------------
Hackeando los semáforos
------------------------

Ok, ahora quiero salvar el entorno con mi nueva técnica.

Básicamente, la idea es tener obtener acceso a la base de datos VAX/VMS o al
computador controlador. Ahora bien, ya que esto está en una LAN interna, y
corre en DECnet vamos a tener que encontrar ideas ingeniosas para meternos.

Algo de ingeniería social puede ayudarte bastante.
Llama a tu municipalidad, o chequea los sitios webs, los diarios o en
cualquier lado, buscando donde específicamente esta situada el ATC. Luego
obtendrás los números de contacto de personas que trabajan ahí o semejantes,
quizás un número de de reportes de fallas. Enciendele fuego a tu dialer y
empieza a explorar los prefijos. Deberían tener un servidor donde llaman
para designar un nuevo controlador o cuando un nuevo software d/l es
necesitado en el campo. En Africa del Sur es un computador corriendo DOS con
pc-anywhere. Pero si son astutos, como todos los centro que yo he visto,
ellos tendrán una instalación de dial-back, de no ser así, estás de suerte
ya que entonces estás conectado directamente a la LAN interna, y deberías
empezar a hackear el VAX o FEP. El FEP es normalmente un sistema configurado
a conveniencia, como en Africa del Sur, donde corre DOS con los mayores
protocolos seriales de comunicación. Lo mejor es obtener acceso a un
computador controlador VAX/OS2 para tener un sistema más familiar, aunque el
FEP tiene más control de el sistema de mensajes del controlador. Y puedes
acceder a las conexiones seriales a los modems de forma directa.

Si no tienes suerte y tiene un ATC astuto. Debes diseñar otro medio para
acceder a la LAN interna. En mi experiencia la LAN está siempre conectada al
WAN de la municipalidad para propósitos de mail y para acceder a la intranet
local para reportes de la base de datos de fallas de conducción. Ahora bien,
obtener el acceso a la WAN local no es tán difícil, ya que generalmente son
bastante grandes y proveen un montón de servicios como sitios webs,
servidores mail para trabajadores municipales y semejantes. Ahora hackea un
servidor web o algo y ponle un backdoor pero *MUY* *MUY* bien hecho. Vas a
necesitarlo un montón, quizás debas ponerle backdoors a un par. :)

Ahora en la WAN local, probablemente puedas acceder el nombre de servidor al
LAN ATC o quizás puedas accederlo directamente. No estoy dando un tutorial
de hacking, solo medios de acceso, así que snifa email, tráfico de redes,
bla bla... hasta que obtengas acceso al VAX o el computador controlador.

Una vez que estes adentro de nuevo, hazle un backdoor *MUY* *MUY* *MUY*
bien hecho ;) deberías usar todas las herramientas de vax y similares, busca
entre las phracks por hackeo de VAX/VMS. Hay un par de bonitas herramientas
de 'SHOW USER' y cosas escritas por mentor y otros cuantos. Y una vez que
estés dentro, chequea que hay en la DECnet, y a lo mejor ve si está enlazado
a otro ATC. Desde aquí puedes acceder a los computadores controladores, los
FEP y todo. Intenta ver las conexiones seriales directamente a través del
FEP o ver la comunicación desde el computador controlador, para que puedes
entender el formato de los controles de mensajería. O si eres suertudo,
puedes acceder el programa en sí usado para la mensajería, si es amistoso
con los terminales.

Ahora busca por los controladores de los cuales posees las localización, la
mayoría de las direcciones son fáciles de adivinar la mayoría del tiempo o
simplemente navega a través de la base de datos VAX por reportes de fallas o
chequea la intranet local. Construye un mensaje adecuado y un datagrama de
los datos capturados, y hazlo hacer algo que se note como: UTC message - PX
DEMAND PEDESTRIAN STAGE (Demanda etapa de peatones).
Por suerte, tienes un laptop o algo así, ve donde el controlador al cual le
intentas enviar el mensaje. Notarás que todo esto es hecho sobre tcp/ip, ya
que te enlazas a la LAN donde entras al VAX/VMS DECnet y a su vez en el
computador controlador/FEP. Entonces, envía un comando y mira si el
controlador te obedece. Si lo hace, entonces puedes comenzar a programar el
proceso completo ;). haz  unos bonitos para viajes entre el punto A y B
amistosos con el AMBIENTE. Además es bueno tener los comandos para forzar
una etapa, UTC message - Fn  ; si estás atascado en una luz roja, sentado
ahi contaminando el aire, solo fuerza la siguiente etapa en la secuencia, y
vete sin la culpa de haber cruzado una luz roja ;)

Además si estás navegando la LAN, busca por información valiosa como por
ejemplo, la fuente al firmware de los controladores ya que el firmware es
actualizado bastante frecuentemente. Puedes estar por ahí en algún servidor
dialup o algún servidor ftp interno. La frecuencia exacta y la secuencia de
bit usada para iniciar el ciclo de emergencia en los controladores, para
ambulancias y vehículos de emergencias, es algo valioso también. Hay además
un software que es usado para designar los controladores y la unidad manual
para monitoreo de campo.

Por supuesto que hackear el sistema de tráfico puede ser abusado y tener
desastrosos efectos, pero siento, que si tienes las habilidades para acceder
a un sistema como este, entonces tendrás además el sentido de no cagarlo.


|=[ EOF ]=---------------------------------------------------------------=|